# 钓鱼系统文档

## 概述

钓鱼系统是一个基于概率的积分游戏，玩家通过消耗积分使用不同等级的钓鱼竿来钓鱼，有机会获得不同价值的鱼类和积分奖励。

## 系统特性

### 🎣 钓鱼竿系统
- **初级钓鱼竿**: 消耗1000积分，最低收获100积分
- **中级钓鱼竿**: 消耗3000积分，最低收获300积分  
- **高级钓鱼竿**: 消耗5000积分，最低收获500积分

### 🐟 鱼类分类

#### 一类鱼 (75% 概率)
- **河虾**: 100积分 - 虽然小，但也是收获！
- **泥鳅**: 300积分 - 滑溜溜的，手感不错！
- **金枪鱼**: 500积分 - 肉质鲜美，值得期待！

#### 二类鱼 (15% 概率)
- **草鱼**: 1500积分 - 体型不错，收获颇丰！
- **鲫鱼**: 4500积分 - 肉质细嫩，价值不菲！
- **大闸蟹**: 7500积分 - 蟹中之王，运气不错！

#### 三类鱼 (4.9% 概率)
- **大黄鱼**: 3000积分 - 黄金般的色泽，珍贵稀有！
- **毛蟹**: 9000积分 - 蟹中极品，价值连城！
- **金枪鱼**: 15000积分 - 深海霸主，顶级收获！

#### 四类鱼 (0.1% 概率) - 传说鱼
- **金鱼**: 100000积分 - 传说中的神鱼，价值十万！
- **锦鲤**: 100000积分 - 幸运的象征，价值十万！
- **虎鲸**: 100000积分 - 海洋之王，价值十万！

### ❌ 钓鱼失败 (5% 概率)
- 鱼竿损坏，无法获得任何奖励
- 提供鼓励性提示信息

## 文件结构

```
bot/
├── config/
│   └── fishing_config.py      # 钓鱼系统配置
├── common/
│   └── fishing_service.py     # 钓鱼业务逻辑服务
└── handlers/
    └── fishing_handler.py     # Telegram机器人钓鱼处理器

test_fishing.py                # 钓鱼系统测试文件
docs/
└── fishing_system.md         # 本文档
```

## 使用方法

### 1. 配置环境变量

```bash
# 设置传说鱼通知群组ID (可选)
export FISHING_NOTIFICATION_GROUPS="-1001234567890,-1001987654321"

# 设置订阅号链接
export SUBSCRIPTION_LINK="https://t.me/your_subscription"
```

### 2. 在机器人中注册钓鱼处理器

```python
from bot.handlers.fishing_handler import FishingHandler

# 在机器人启动时注册
fishing_handler = FishingHandler(client)
```

### 3. 用户命令

- `/fishing` - 打开钓鱼界面
- `/fishing_history` - 查看钓鱼历史记录

## 核心类说明

### FishingConfig
钓鱼系统配置类，包含所有钓鱼规则和概率设置。

**主要方法:**
- `get_fishing_result(rod_type)` - 获取钓鱼结果
- `get_rod_info(rod_type)` - 获取钓鱼竿信息
- `format_legendary_notification()` - 格式化传说鱼通知

### FishingService
钓鱼业务逻辑服务类，处理积分扣除、奖励发放等业务逻辑。

**主要方法:**
- `can_fish(user_id, rod_type)` - 检查是否可以钓鱼
- `fish(user_id, rod_type)` - 执行钓鱼操作
- `get_fishing_info(user_id)` - 获取钓鱼信息
- `get_fishing_history(user_id)` - 获取钓鱼历史

### FishingHandler
Telegram机器人钓鱼处理器，处理用户交互和消息发送。

**主要功能:**
- 处理钓鱼命令和回调
- 构建钓鱼界面消息
- 发送传说鱼通知到群组

## 概率分析

### 期望值计算
- **初级钓鱼竿**: 平均收益约800积分，期望值-200积分
- **中级钓鱼竿**: 平均收益约2400积分，期望值-600积分  
- **高级钓鱼竿**: 平均收益约4000积分，期望值-1000积分

### 传说鱼机制
- 基础概率: 0.1%
- 可动态调整概率，例如当系统盈利2倍时增加传说鱼出现概率
- 钓到传说鱼时自动发送全服通知

## 测试

运行测试文件验证系统逻辑：

```bash
python test_fishing.py
```

测试内容包括：
- 钓鱼配置验证
- 概率分布测试
- 期望值分析
- 传说鱼通知测试

## 配置说明

### 钓鱼竿配置
```python
FISHING_RODS = {
    "初级": FishingRod(
        name="初级钓鱼竿",
        cost=1000,
        min_fish_points=100,
        description="新手必备，虽然简单但也能钓到大鱼哦！"
    ),
    # ... 其他钓鱼竿
}
```

### 鱼类配置
```python
FISH_CATEGORIES = {
    "一类鱼": FishCategory(
        name="一类鱼",
        probability=0.75,
        fishes=[...],
        description="常见鱼类，容易钓到"
    ),
    # ... 其他鱼类分类
}
```

## 扩展功能

### 1. 动态概率调整
可以根据系统盈利情况动态调整传说鱼出现概率：

```python
def adjust_legendary_probability(profit_ratio):
    """根据盈利比例调整传说鱼概率"""
    if profit_ratio > 2.0:  # 盈利超过2倍
        return 0.002  # 增加概率
    return 0.001  # 默认概率
```

### 2. 钓鱼竿升级系统
可以添加钓鱼竿升级功能，提高钓鱼成功率：

```python
def upgrade_fishing_rod(user_id, rod_type):
    """升级钓鱼竿"""
    # 实现升级逻辑
    pass
```

### 3. 钓鱼比赛
可以添加定时钓鱼比赛功能：

```python
def start_fishing_contest():
    """开始钓鱼比赛"""
    # 实现比赛逻辑
    pass
```

## 注意事项

1. **概率设置**: 确保各类鱼的概率总和加上失败概率不超过100%
2. **积分安全**: 钓鱼操作涉及积分扣除和奖励，需要确保事务的原子性
3. **通知配置**: 传说鱼通知需要正确配置群组ID
4. **性能优化**: 大量用户同时钓鱼时需要考虑性能优化
5. **防作弊**: 可以添加钓鱼频率限制和异常检测

## 故障排除

### 常见问题

1. **钓鱼失败率高**
   - 检查概率配置是否正确
   - 验证随机数生成器是否正常工作

2. **传说鱼通知未发送**
   - 检查群组ID配置
   - 验证机器人权限

3. **积分计算错误**
   - 检查数据库事务是否正确提交
   - 验证积分扣除和奖励逻辑

### 日志监控

系统会记录以下关键日志：
- 钓鱼操作结果
- 传说鱼出现记录
- 积分交易记录
- 错误和异常信息

通过监控这些日志可以及时发现和解决问题。 