# 群组消息监控功能

## 概述

群组消息监控功能可以实时监控群组中所有成员发送的消息，包括文本、图片、视频、音频、贴纸等各种类型的消息。该功能提供了详细的统计信息，帮助管理员了解群组的活跃度和用户行为。

## 功能特性

### 1. 消息类型监控
- **文本消息**: 普通文字消息
- **图片消息**: 图片及其描述
- **视频消息**: 视频及其描述
- **音频消息**: 音频文件及其描述
- **语音消息**: 语音消息
- **文档消息**: 文档文件
- **贴纸消息**: 贴纸表情
- **动画消息**: GIF动画
- **联系人消息**: 联系人信息
- **位置消息**: 位置信息
- **投票消息**: 投票内容

### 2. 统计维度
- **按群组统计**: 每个群组的消息数量、活跃用户数、消息类型分布
- **按用户统计**: 每个用户的消息数量、活跃群组数、消息类型分布
- **按消息类型统计**: 全局消息类型分布
- **按时间统计**: 按小时和按天的消息统计

### 3. 管理命令

#### `/msg_stats` - 显示消息统计信息
显示全局消息统计信息，包括：
- 运行时间
- 总消息数
- 活跃群组数和用户数
- 最活跃的群组和用户
- 消息类型分布

**权限**: 仅管理员可用

#### `/reset_msg_stats` - 重置统计信息
清空所有统计数据，重新开始统计。

**权限**: 仅管理员可用

#### `/group_activity` - 显示当前群组活动
显示当前群组的详细活动统计，包括：
- 群组总消息数
- 活跃用户数
- 消息类型分布
- 最活跃用户

**权限**: 仅管理员可用

## 技术实现

### 文件结构
```
bot/handlers/group_message_monitor.py  # 主要监控处理器
```

### 核心组件

#### GroupMessageMonitor 类
负责记录和统计消息数据的主要类。

#### 主要函数
- `log_message()`: 记录单条消息
- `get_message_stats()`: 获取统计信息
- `format_message_stats()`: 格式化统计信息

### 数据存储
统计数据存储在内存中，包括：
- `message_stats`: 全局统计数据
- `group_messages`: 按群组统计
- `user_messages`: 按用户统计
- `message_types`: 按消息类型统计

## 使用示例

### 1. 启动监控
监控功能会在机器人启动时自动启用，无需额外配置。

### 2. 查看统计
在任意群组或私聊中发送 `/msg_stats` 命令查看统计信息。

### 3. 查看群组活动
在群组中发送 `/group_activity` 命令查看该群组的详细活动统计。

### 4. 重置统计
发送 `/reset_msg_stats` 命令重置所有统计数据。

## 日志记录

监控功能会记录详细的日志信息，包括：
- 消息发送者信息
- 群组信息
- 消息类型
- 消息内容（前100个字符）

日志格式：
```
群组消息 | 用户: 用户名 (ID: 用户ID) | 群组: 群组名 (ID: 群组ID) | 类型: 消息类型 | 内容: 消息内容
```

## 性能考虑

1. **内存使用**: 统计数据存储在内存中，长时间运行可能占用较多内存
2. **日志量**: 每个消息都会记录日志，高活跃群组可能产生大量日志
3. **响应时间**: 监控处理对消息响应时间影响很小

## 注意事项

1. **权限控制**: 统计命令仅限管理员使用
2. **数据持久化**: 当前统计数据存储在内存中，重启后会丢失
3. **隐私保护**: 只记录消息类型和内容摘要，不存储完整消息内容
4. **性能监控**: 建议定期检查日志文件大小和内存使用情况

## 扩展功能

可以考虑添加的功能：
1. **数据持久化**: 将统计数据保存到数据库
2. **实时图表**: 提供Web界面显示统计图表
3. **告警功能**: 当群组活跃度异常时发送告警
4. **用户行为分析**: 分析用户活跃时间、消息模式等
5. **群组对比**: 对比不同群组的活跃度

## 故障排除

### 常见问题

1. **命令无响应**
   - 检查机器人是否有管理员权限
   - 确认命令格式正确

2. **统计数据显示异常**
   - 尝试重置统计数据
   - 检查日志文件是否有错误信息

3. **内存占用过高**
   - 定期重置统计数据
   - 考虑增加内存限制

### 调试方法

1. 查看日志文件 `logs/bot.log`
2. 使用测试脚本 `test_group_message_monitor.py` 验证功能
3. 检查机器人权限和配置 